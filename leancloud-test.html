<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeanCloud连接测试</title>
    <script src="https://unpkg.com/leancloud-storage@4.13.0/dist/av-min.js"></script>
</head>
<body>
    <h1>LeanCloud连接测试</h1>
    <div id="status">正在初始化...</div>
    <div id="result"></div>
    <div id="debug"></div>
    
    <script src="leancloud-config.js"></script>
    <script>
        // 显示调试信息
        const debugDiv = document.getElementById('debug');
        debugDiv.innerHTML = '<h3>调试信息:</h3>';
        debugDiv.innerHTML += '<p>当前页面URL: ' + window.location.href + '</p>';
        
        // 等待LeanCloud初始化完成
        setTimeout(function() {
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result');
            
            // 检查LeanCloud是否已初始化
            if (typeof LEANCLOUD_CONFIG !== 'undefined' && typeof LEANCLOUD_CONFIG.AV !== 'undefined') {
                statusDiv.innerHTML = '<p style="color: green;">✅ LeanCloud已成功初始化</p>';
                debugDiv.innerHTML += '<p>LeanCloud版本: ' + LEANCLOUD_CONFIG.AV.version + '</p>';
                debugDiv.innerHTML += '<p>Server URL: https://eenvurhh.api.lncldglobal.com</p>';
                
                // 测试连接
                try {
                    // 创建一个测试对象
                    const TestObject = LEANCLOUD_CONFIG.AV.Object.extend('TestConnection');
                    const testObj = new TestObject();
                    testObj.set('testField', 'testValue');
                    testObj.set('timestamp', new Date().toISOString());
                    
                    debugDiv.innerHTML += '<p>正在尝试保存测试对象...</p>';
                    
                    // 保存测试对象
                    testObj.save().then(function(result) {
                        resultDiv.innerHTML = '<p style="color: green;">✅ LeanCloud数据库连接正常，测试对象保存成功</p>' +
                                             '<p>对象ID: ' + result.id + '</p>' +
                                             '<p>创建时间: ' + result.createdAt + '</p>';
                        debugDiv.innerHTML += '<p>保存成功，对象ID: ' + result.id + '</p>';
                    }).catch(function(error) {
                        resultDiv.innerHTML = '<p style="color: red;">❌ 保存测试对象失败: ' + error.message + '</p>';
                        debugDiv.innerHTML += '<p style="color: red;">错误详情: ' + JSON.stringify(error) + '</p>';
                        
                        // 提供解决方案建议
                        if (error.message.includes('Origin is not allowed')) {
                            resultDiv.innerHTML += '<p style="color: orange;"><strong>解决方案:</strong> 请在LeanCloud控制台的"安全中心" -> "Web安全域名"中添加当前域名: ' + window.location.origin + '</p>';
                        }
                    });
                } catch (error) {
                    resultDiv.innerHTML = '<p style="color: red;">❌ 测试过程中发生错误: ' + error.message + '</p>';
                    debugDiv.innerHTML += '<p style="color: red;">捕获错误: ' + JSON.stringify(error) + '</p>';
                }
            } else {
                statusDiv.innerHTML = '<p style="color: red;">❌ LeanCloud初始化失败</p>';
                resultDiv.innerHTML = '<p>请检查网络连接和配置文件</p>';
            }
        }, 2000); // 等待2秒确保初始化完成
    </script>
</body>
</html>