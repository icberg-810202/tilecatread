# COZE数据库集成指南

本指南将帮助您将语录应用与COZE数据库进行集成，实现用户数据的跨设备同步。

## 1. 创建COZE项目

1. 访问 [COZE官方网站](https://www.coze.cn)
2. 注册/登录您的COZE账户
3. 创建一个新的COZE项目

## 2. 配置数据库

在COZE平台上创建和配置数据库的详细步骤：

1. **进入数据库管理**：
   - 登录COZE平台后，在左侧菜单中查找「数据库」、「数据管理」或「存储」选项
   - 如果找不到专门的数据库部分，可能需要在智能体设置中找到「数据存储」相关选项

2. **创建集合/表**：
   - 点击「创建集合」或「新建表」按钮
   - 将集合名称设置为`users`（必须使用此名称以匹配应用代码）
   - 设置集合的访问权限为「私有」或「仅授权访问」

3. **数据结构配置**（如需要）：
   - 如果COZE平台支持预定义数据结构，请按照以下格式设置字段：
     - `userId`：字符串类型（主键）
     - `books`：数组类型，包含书籍对象
   - 注意：部分NoSQL数据库可能不需要预定义结构，可以直接存储JSON数据

4. **测试数据插入**（可选）：
   - 创建集合后，可以尝试手动插入一条测试数据，以验证数据库配置是否正确
   - 示例测试数据：
     ```json
     {
       "userId": "testuser",
       "books": [
         {
           "name": "测试书籍",
           "author": "测试作者",
           "selected": true,
           "quotes": [
             {
               "text": "这是一条测试语录",
               "page": "1",
               "tags": ["测试"]
             }
           ]
         }
       ]
     }
     ```

5. **替代方案**：
   - 如果在COZE平台上找不到独立的数据库功能，可以尝试以下替代方案：
     - 使用COZE的「数据存储」或「知识库」功能
     - 或者考虑使用其他支持REST API的云数据库服务，如Firebase、MongoDB Atlas等

## 3. 获取API密钥

根据COZE平台的最新界面，获取API密钥的详细步骤如下：

### 方法一：通过个人设置获取
1. 登录COZE开放平台（https://www.coze.com/open）
2. 点击右上角的个人头像，选择「个人设置」
3. 在左侧菜单中找到「API Keys」选项
4. 点击「Create New Key」按钮生成新的API密钥
5. 新生成的API密钥格式通常为「cz-xxx」开头
6. 复制并保存该密钥，因为它只显示一次

### 方法二：通过团队设置获取
如果方法一找不到，请尝试：
1. 登录COZE平台
2. 在左侧【菜单】中找到【团队设置】
3. 进入【大模型设置】页面
4. 在此页面中创建一个新的令牌
5. 创建完成后，点击「发布」按钮激活该令牌
6. 保存生成的API密钥

**重要提示**：
- 请确保先创建令牌，然后再进行发布操作
- API密钥只会显示一次，请妥善保存
- 如果仍然找不到相关选项，可能需要先创建一个智能体（机器人），然后才能访问API设置

## 4. 配置API权限

在获取API密钥后，您需要确保该密钥具有以下必要的权限：

1. **访问控制设置**：
   - 在API密钥创建页面，通常会有相关的权限选择选项
   - 请确保勾选所有与数据访问相关的权限

2. **必要权限列表**：
   - 用户认证权限（允许用户登录和注册）
   - 数据库读取权限（读取用户数据）
   - 数据库写入权限（保存用户数据）
   - 如果有单独的集合/表权限设置，请确保对"users"集合有完全访问权限

3. **权限验证**：
   - 部分API密钥可能默认具有所需权限
   - 如果在使用过程中遇到权限错误，请返回COZE平台检查并调整API密钥的权限设置

4. **跨域设置**（如需要）：
   - 如果应用部署在特定域名上，可能需要在COZE平台的安全设置中添加您的域名到允许列表
   - 这通常在「安全设置」或「跨域配置」部分

## 5. 修改应用配置

在您的项目中，打开 `script.js` 文件，找到以下配置部分并更新：

```javascript
// COZE数据库配置 - 用户需要替换为自己的COZE API密钥和项目信息
const cozeConfig = {
    apiKey: "YOUR_COZE_API_KEY",  // 替换为您的COZE API密钥
    baseUrl: "https://api.coze.cn/open_api/v1"  // 如有不同，请按照COZE文档更新
};
```

## 6. 了解数据结构

应用使用以下数据结构存储在COZE数据库中：

```javascript
{
    "userId": "用户名",  // 主键，使用用户名作为用户唯一标识
    "collection": "users",  // 集合名称
    "data": {
        "books": [
            {
                "name": "书籍名称",
                "author": "作者",
                "selected": true,  // 是否在启动页显示
                "quotes": [
                    {
                        "text": "语录内容",
                        "page": "页码（可选）",
                        "tags": ["标签1", "标签2"]  // 标签（可选）
                    }
                    // 更多语录...
                ]
            }
            // 更多书籍...
        ]
    }
}
```

## 7. 测试集成

1. 保存您的更改
2. 部署应用到Netlify或其他静态网站托管服务
3. 注册一个新用户
4. 添加一些书籍和语录
5. 在不同设备上使用相同账号登录，确认数据是否正确同步

## 8. 注意事项

1. **API密钥安全**：请勿在前端代码中直接暴露敏感的API密钥。在生产环境中，建议使用后端代理。

2. **跨域问题**：如果遇到跨域错误，请确保COZE API已配置允许您的域名访问。

3. **错误处理**：应用包含基本的错误处理，但在生产环境中可能需要更完善的错误恢复机制。

4. **会话管理**：当前实现使用浏览器的sessionStorage保存登录状态，关闭浏览器后需要重新登录。如需持久化登录，请修改为使用localStorage。

## 9. 故障排除

### 常见问题与解决方案

1. **找不到API密钥选项**：
   - **问题**：在COZE平台上找不到生成API密钥的地方
   - **解决方案**：
     - 确保您登录的是COZE开放平台（https://www.coze.com/open）而非普通平台
     - 尝试使用不同的浏览器或清除浏览器缓存
     - 确认您的账户已完成实名认证（部分平台要求）
     - 如果仍然找不到，请联系COZE平台客服获取帮助

2. **找不到数据库功能**：
   - **问题**：在COZE平台上找不到数据库或数据存储功能
   - **解决方案**：
     - 检查是否需要先创建一个智能体才能访问数据功能
     - 查找「数据存储」、「知识库」、「云存储」等类似选项
     - 尝试在智能体的「高级设置」或「集成设置」中查找
     - 考虑使用替代方案，如返回使用Firebase（代码已预留）

3. **登录失败**：
   - 检查API密钥是否正确，注意区分大小写
   - 确认API密钥没有过期
   - 查看浏览器控制台的错误信息，了解具体失败原因

4. **数据不保存**：
   - 检查网络连接是否正常
   - 确认API密钥权限是否正确配置
   - 查看浏览器控制台是否有错误信息
   - 检查集合名称是否为「users」（区分大小写）

5. **跨域错误**：
   - 如果控制台显示CORS错误，需要在COZE平台配置允许的域名
   - 本地开发时，可以使用浏览器的跨域插件临时解决

### 替代解决方案

如果在COZE平台上遇到无法解决的问题，可以考虑以下替代方案：

1. **返回使用Firebase**：
   - 我们的代码之前已集成Firebase，您可以恢复使用Firebase
   - 需要重新在index.html中添加Firebase SDK引用
   - 并恢复script.js中的Firebase相关代码

2. **使用其他云数据库**：
   - MongoDB Atlas：提供免费计划和REST API
   - Supabase：开源Firebase替代品，提供完整的数据库功能
   - Backendless：提供易于使用的API和数据库服务

### 查看日志

所有操作都会在浏览器控制台记录日志，您可以通过按F12并切换到「控制台」标签来查看详细信息。错误信息通常会指出具体的问题所在，如API密钥无效、权限不足或请求格式错误等。

## 10. 进一步开发

如需扩展功能，您可以考虑：

1. 添加密码重置功能
2. 实现用户头像
3. 添加更多书籍元数据字段
4. 实现更复杂的搜索功能
5. 添加数据导出/导入功能